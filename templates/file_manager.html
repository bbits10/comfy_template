<!DOCTYPE html>
<html>
  <head>
    <title>ComfyUI File Manager</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .file-icon {
        width: 24px;
        text-align: center;
      }
      .folder-row:hover,
      .file-row:hover {
        background-color: #f8f9fa;
        cursor: pointer;
      }
      .breadcrumb-item a {
        text-decoration: none;
      }
      .storage-info {
        font-size: 0.9em;
      }
      .progress {
        height: 20px;
      }
      .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
      }
      .table-responsive {
        max-height: 60vh;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid mt-3">
      <div class="row">
        <div class="col-12">
          <h1 class="mb-3">
            <i class="fas fa-folder-open"></i> ComfyUI File Manager
          </h1>

          <!-- Storage Information -->
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title">Storage Information</h5>
              <div id="storage-info" class="storage-info">
                <div class="row">
                  <div class="col-md-4">
                    <strong>Output Folder:</strong>
                    <span id="output-size">Loading...</span>
                  </div>
                  <div class="col-md-4">
                    <strong>Total Files:</strong>
                    <span id="file-count">Loading...</span>
                  </div>
                  <div class="col-md-4">
                    <strong>Disk Usage:</strong>
                    <span id="disk-usage">Loading...</span>
                  </div>
                </div>
                <div class="mt-2">
                  <div class="progress">
                    <div
                      id="disk-progress"
                      class="progress-bar"
                      role="progressbar"
                      style="width: 0%"
                    ></div>
                  </div>
                  <small class="text-muted">
                    <span id="disk-free">0 B</span> free of
                    <span id="disk-total">0 B</span>
                  </small>
                </div>
              </div>
            </div>
          </div>

          <!-- Navigation and Actions -->
          <div class="card mb-4">
            <div class="card-body">
              <!-- Breadcrumb Navigation -->
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-3">
                  <li class="breadcrumb-item">
                    <a href="?path="><i class="fas fa-home"></i> Output</a>
                  </li>
                  {% for breadcrumb in breadcrumbs %}
                  <li class="breadcrumb-item">
                    <a href="?path={{ breadcrumb.path }}"
                      >{{ breadcrumb.name }}</a
                    >
                  </li>
                  {% endfor %}
                </ol>
              </nav>

              <!-- Action Buttons -->
              <div class="row">
                <div class="col-md-8">
                  <button
                    class="btn btn-primary btn-sm"
                    onclick="refreshPage()"
                  >
                    <i class="fas fa-sync-alt"></i> Refresh
                  </button>
                  <button
                    class="btn btn-success btn-sm"
                    onclick="showCreateFolderModal()"
                  >
                    <i class="fas fa-folder-plus"></i> New Folder
                  </button>
                  {% if current_path %}
                  <a
                    href="/download_folder?path={{ current_path }}"
                    class="btn btn-info btn-sm"
                  >
                    <i class="fas fa-download"></i> Download Folder as ZIP
                  </a>
                  {% endif %}
                </div>
                <div class="col-md-4 text-end">
                  <button class="btn btn-warning btn-sm" onclick="selectAll()">
                    <i class="fas fa-check-square"></i> Select All
                  </button>
                  <button
                    class="btn btn-danger btn-sm"
                    onclick="deleteSelected()"
                  >
                    <i class="fas fa-trash"></i> Delete Selected
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- File Listing -->
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th width="40">
                        <input
                          type="checkbox"
                          id="select-all-checkbox"
                          onchange="toggleSelectAll()"
                        />
                      </th>
                      <th width="50"></th>
                      <th>Name</th>
                      <th width="120">Size</th>
                      <th width="150">Modified</th>
                      <th width="120">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% if contents|length == 0 %}
                    <tr>
                      <td colspan="6" class="text-center text-muted py-4">
                        <i class="fas fa-folder-open fa-3x mb-3"></i><br />
                        No files or folders found
                      </td>
                    </tr>
                    {% endif %} {% for item in contents %}
                    <tr
                      class="{{ 'folder-row' if item.type == 'folder' else 'file-row' }}"
                      data-path="{{ current_path }}/{{ item.name if current_path else item.name }}"
                    >
                      <td>
                        <input
                          type="checkbox"
                          class="item-checkbox"
                          value="{{ current_path }}/{{ item.name if current_path else item.name }}"
                        />
                      </td>
                      <td class="file-icon">
                        {% if item.type == 'folder' %}
                        <i class="fas fa-folder text-warning"></i>
                        {% elif item.name.lower().endswith(('.png', '.jpg',
                        '.jpeg', '.gif', '.bmp', '.webp')) %}
                        <i class="fas fa-image text-primary"></i>
                        {% elif item.name.lower().endswith(('.mp4', '.avi',
                        '.mov', '.webm')) %}
                        <i class="fas fa-video text-success"></i>
                        {% elif item.name.lower().endswith(('.zip', '.rar',
                        '.7z', '.tar', '.gz')) %}
                        <i class="fas fa-file-archive text-secondary"></i>
                        {% else %}
                        <i class="fas fa-file text-info"></i>
                        {% endif %}
                      </td>
                      <td>
                        {% if item.type == 'folder' %}
                        <a
                          href="?path={{ current_path }}/{{ item.name if current_path else item.name }}"
                          class="text-decoration-none"
                        >
                          <strong>{{ item.name }}</strong>
                          <small class="text-muted"
                            >({{ item.file_count }} files)</small
                          >
                        </a>
                        {% else %}
                        <span>{{ item.name }}</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if item.type == 'folder' %}
                        <small class="text-muted">Folder</small>
                        {% else %} {{ format_size(item.size) }} {% endif %}
                      </td>
                      <td>
                        <small>{{ item.modified }}</small>
                      </td>
                      <td>
                        {% if item.type == 'folder' %}
                        <a
                          href="/download_folder?path={{ current_path }}/{{ item.name if current_path else item.name }}"
                          class="btn btn-sm btn-outline-info"
                          title="Download as ZIP"
                        >
                          <i class="fas fa-download"></i>
                        </a>
                        {% else %}
                        <a
                          href="/download?path={{ current_path }}/{{ item.name if current_path else item.name }}"
                          class="btn btn-sm btn-outline-primary"
                          title="Download"
                        >
                          <i class="fas fa-download"></i>
                        </a>
                        {% endif %}
                        <button
                          class="btn btn-sm btn-outline-danger"
                          onclick="deleteItem('{{ current_path }}/{{ item.name if current_path else item.name }}')"
                          title="Delete"
                        >
                          <i class="fas fa-trash"></i>
                        </button>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Folder Modal -->
    <div class="modal fade" id="createFolderModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Create New Folder</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="create-folder-form">
              <div class="mb-3">
                <label for="folder-name" class="form-label">Folder Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="folder-name"
                  placeholder="Enter folder name"
                  required
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="createFolder()"
            >
              Create Folder
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      // Load storage info on page load
      $(document).ready(function () {
        loadStorageInfo();
      });

      function loadStorageInfo() {
        $.get("/get_storage_info")
          .done(function (data) {
            $("#output-size").text(data.output_size_formatted);
            $("#file-count").text(data.file_count);
            $("#disk-usage").text(data.disk_used_formatted);
            $("#disk-free").text(data.disk_free_formatted);
            $("#disk-total").text(data.disk_total_formatted);

            const usagePercent = (
              (data.disk_used / data.disk_total) *
              100
            ).toFixed(1);
            $("#disk-progress")
              .css("width", usagePercent + "%")
              .text(usagePercent + "%");

            if (usagePercent > 90) {
              $("#disk-progress")
                .removeClass("bg-success bg-warning")
                .addClass("bg-danger");
            } else if (usagePercent > 70) {
              $("#disk-progress")
                .removeClass("bg-success bg-danger")
                .addClass("bg-warning");
            } else {
              $("#disk-progress")
                .removeClass("bg-warning bg-danger")
                .addClass("bg-success");
            }
          })
          .fail(function () {
            $("#storage-info").html(
              '<div class="text-danger">Failed to load storage information</div>'
            );
          });
      }

      function refreshPage() {
        location.reload();
      }

      function showCreateFolderModal() {
        $("#folder-name").val("");
        new bootstrap.Modal(
          document.getElementById("createFolderModal")
        ).show();
      }

      function createFolder() {
        const folderName = $("#folder-name").val().trim();
        if (!folderName) {
          alert("Please enter a folder name");
          return;
        }

        const currentPath = "{{ current_path }}";

        $.ajax({
          url: "/create_folder",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({
            current_path: currentPath,
            folder_name: folderName,
          }),
          success: function () {
            bootstrap.Modal.getInstance(
              document.getElementById("createFolderModal")
            ).hide();
            location.reload();
          },
          error: function (xhr) {
            const error = xhr.responseJSON
              ? xhr.responseJSON.error
              : "Unknown error";
            alert("Error creating folder: " + error);
          },
        });
      }

      function deleteItem(path) {
        if (
          !confirm(
            "Are you sure you want to delete this item? This action cannot be undone."
          )
        ) {
          return;
        }

        $.ajax({
          url: "/delete",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({ path: path }),
          success: function () {
            location.reload();
          },
          error: function (xhr) {
            const error = xhr.responseJSON
              ? xhr.responseJSON.error
              : "Unknown error";
            alert("Error deleting item: " + error);
          },
        });
      }

      function toggleSelectAll() {
        const selectAll = $("#select-all-checkbox").is(":checked");
        $(".item-checkbox").prop("checked", selectAll);
      }

      function selectAll() {
        $(".item-checkbox").prop("checked", true);
        $("#select-all-checkbox").prop("checked", true);
      }

      function deleteSelected() {
        const selected = $(".item-checkbox:checked")
          .map(function () {
            return $(this).val();
          })
          .get();

        if (selected.length === 0) {
          alert("Please select items to delete");
          return;
        }

        if (
          !confirm(
            `Are you sure you want to delete ${selected.length} selected item(s)? This action cannot be undone.`
          )
        ) {
          return;
        }

        let completed = 0;
        let errors = [];

        selected.forEach(function (path) {
          $.ajax({
            url: "/delete",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ path: path }),
            success: function () {
              completed++;
              if (completed === selected.length) {
                if (errors.length > 0) {
                  alert(
                    `Deleted ${
                      completed - errors.length
                    } items. Errors: ${errors.join(", ")}`
                  );
                }
                location.reload();
              }
            },
            error: function (xhr) {
              completed++;
              errors.push(path);
              if (completed === selected.length) {
                if (errors.length > 0) {
                  alert(
                    `Deleted ${
                      completed - errors.length
                    } items. Errors: ${errors.join(", ")}`
                  );
                }
                location.reload();
              }
            },
          });
        });
      }

      // Handle folder/file row clicks for navigation
      $(".folder-row").click(function (e) {
        if (
          e.target.type !== "checkbox" &&
          !$(e.target).closest("a, button").length
        ) {
          const path = $(this).data("path");
          window.location.href = "?path=" + encodeURIComponent(path);
        }
      });
    </script>
  </body>
</html>
