<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced File Manager - ComfyUI</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
        font-size: 14px;
      }

      .sidebar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 0;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      }

      .sidebar .nav-link {
        color: rgba(255, 255, 255, 0.8);
        padding: 12px 20px;
        border-radius: 0;
        transition: all 0.3s ease;
      }

      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
        color: white;
        background-color: rgba(255, 255, 255, 0.1);
        transform: translateX(5px);
      }

      .sidebar .nav-link i {
        width: 20px;
        margin-right: 10px;
      }

      .toolbar {
        background: white;
        border-bottom: 1px solid #dee2e6;
        padding: 15px 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .breadcrumb {
        background: none;
        padding: 0;
        margin: 0;
      }

      .breadcrumb-item a {
        color: #495057;
        text-decoration: none;
        transition: color 0.3s ease;
      }

      .breadcrumb-item a:hover {
        color: #007bff;
      }

      .file-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        padding: 20px 0;
      }

      .file-item {
        background: white;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .file-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        border-color: #007bff;
      }

      .file-item.selected {
        border-color: #007bff;
        background-color: #f8f9ff;
      }

      .file-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
        display: block;
      }

      .file-icon.folder {
        color: #ffc107;
      }
      .file-icon.image {
        color: #28a745;
      }
      .file-icon.video {
        color: #dc3545;
      }
      .file-icon.audio {
        color: #6f42c1;
      }
      .file-icon.text {
        color: #17a2b8;
      }
      .file-icon.code {
        color: #fd7e14;
      }
      .file-icon.pdf {
        color: #dc3545;
      }
      .file-icon.archive {
        color: #6c757d;
      }
      .file-icon.model {
        color: #e83e8c;
      }
      .file-icon.file {
        color: #495057;
      }

      .file-name {
        font-weight: 500;
        margin-bottom: 5px;
        word-break: break-all;
        font-size: 0.9rem;
      }

      .file-info {
        font-size: 0.75rem;
        color: #6c757d;
        line-height: 1.3;
      }

      .file-list {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .file-list-header {
        background: #f8f9fa;
        padding: 12px 15px;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
        display: grid;
        grid-template-columns: 40px 1fr 100px 120px 80px 40px;
        gap: 10px;
        align-items: center;
      }

      .file-list-item {
        padding: 10px 15px;
        border-bottom: 1px solid #f1f3f4;
        display: grid;
        grid-template-columns: 40px 1fr 100px 120px 80px 40px;
        gap: 10px;
        align-items: center;
        transition: background-color 0.2s ease;
        cursor: pointer;
      }

      .file-list-item:hover {
        background-color: #f8f9fa;
      }

      .file-list-item.selected {
        background-color: #e3f2fd;
      }

      .sort-header {
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .sort-header:hover {
        color: #007bff;
      }

      .storage-info {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .progress {
        height: 8px;
        border-radius: 4px;
      }

      .modal-backdrop {
        backdrop-filter: blur(3px);
      }

      .btn {
        border-radius: 6px;
        transition: all 0.3s ease;
      }

      .btn:hover {
        transform: translateY(-1px);
      }

      .search-box {
        position: relative;
      }

      .search-box .form-control {
        padding-left: 35px;
        border-radius: 20px;
      }

      .search-box .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
      }

      .upload-zone {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        background: #f8f9fa;
        transition: all 0.3s ease;
      }

      .upload-zone:hover,
      .upload-zone.dragover {
        border-color: #007bff;
        background: #f0f8ff;
      }

      .context-menu {
        position: absolute;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        min-width: 180px;
        display: none;
      }

      .context-menu-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f1f3f4;
        transition: background-color 0.2s ease;
      }

      .context-menu-item:last-child {
        border-bottom: none;
      }

      .context-menu-item:hover {
        background-color: #f8f9fa;
      }

      .context-menu-item i {
        width: 16px;
        margin-right: 10px;
      }

      .selection-bar {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border-radius: 6px;
        margin-bottom: 15px;
        display: none;
        align-items: center;
        justify-content: space-between;
      }

      .view-toggle {
        display: flex;
        gap: 5px;
      }

      .view-toggle .btn {
        padding: 8px 12px;
      }

      @media (max-width: 768px) {
        .file-grid {
          grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
          gap: 10px;
        }

        .file-list-header,
        .file-list-item {
          grid-template-columns: 30px 1fr 80px 30px;
        }

        .file-list-header .d-none.d-md-block,
        .file-list-item .d-none.d-md-block {
          display: none !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="container-fluid h-100">
      <div class="row h-100">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar">
          <div class="p-3">
            <h5 class="text-white mb-3">
              <i class="fas fa-folder-open"></i>
              File Manager
            </h5>
          </div>
          <nav class="nav flex-column">
            <a class="nav-link" href="#" onclick="navigateTo('/workspace')">
              <i class="fas fa-home"></i>
              Workspace
            </a>
            <a
              class="nav-link active"
              href="#"
              onclick="navigateTo('/workspace/ComfyUI/output')"
            >
              <i class="fas fa-image"></i>
              Output
            </a>
            <a
              class="nav-link"
              href="#"
              onclick="navigateTo('/workspace/ComfyUI/input')"
            >
              <i class="fas fa-upload"></i>
              Input
            </a>
            <a
              class="nav-link"
              href="#"
              onclick="navigateTo('/workspace/ComfyUI/models')"
            >
              <i class="fas fa-brain"></i>
              Models
            </a>
            <a
              class="nav-link"
              href="#"
              onclick="navigateTo('/workspace/ComfyUI/custom_nodes')"
            >
              <i class="fas fa-puzzle-piece"></i>
              Custom Nodes
            </a>
            <a class="nav-link" href="#" onclick="navigateTo('/tmp')">
              <i class="fas fa-clock"></i>
              Temp
            </a>
          </nav>

          <!-- Storage Info -->
          <div class="p-3 mt-auto">
            <div class="storage-info" id="storageInfo">
              <div
                class="d-flex justify-content-between align-items-center mb-2"
              >
                <small class="text-white-50">Storage</small>
                <i
                  class="fas fa-sync-alt text-white-50"
                  style="cursor: pointer"
                  onclick="updateStorageInfo()"
                ></i>
              </div>
              <div class="progress mb-2">
                <div
                  class="progress-bar"
                  role="progressbar"
                  style="width: 0%"
                ></div>
              </div>
              <div class="d-flex justify-content-between">
                <small class="text-white-50" id="usedSpace">Loading...</small>
                <small class="text-white-50" id="totalSpace"></small>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 p-0">
          <!-- Toolbar -->
          <div class="toolbar">
            <div class="container-fluid">
              <div class="row align-items-center">
                <div class="col-md-6">
                  <!-- Breadcrumb -->
                  <nav aria-label="breadcrumb">
                    <ol class="breadcrumb" id="breadcrumb">
                      <li class="breadcrumb-item">
                        <a href="#" onclick="navigateTo('/workspace')"
                          >workspace</a
                        >
                      </li>
                    </ol>
                  </nav>
                </div>
                <div class="col-md-6">
                  <div
                    class="d-flex justify-content-end align-items-center gap-2"
                  >
                    <!-- Search -->
                    <div class="search-box" style="width: 200px">
                      <i class="fas fa-search search-icon"></i>
                      <input
                        type="text"
                        class="form-control form-control-sm"
                        placeholder="Search files..."
                        id="searchInput"
                      />
                    </div>

                    <!-- View Toggle -->
                    <div class="view-toggle">
                      <button
                        class="btn btn-sm btn-outline-secondary active"
                        id="gridView"
                        onclick="setView('grid')"
                      >
                        <i class="fas fa-th"></i>
                      </button>
                      <button
                        class="btn btn-sm btn-outline-secondary"
                        id="listView"
                        onclick="setView('list')"
                      >
                        <i class="fas fa-list"></i>
                      </button>
                    </div>

                    <!-- Actions -->
                    <div class="dropdown">
                      <button
                        class="btn btn-sm btn-primary dropdown-toggle"
                        type="button"
                        data-bs-toggle="dropdown"
                      >
                        <i class="fas fa-plus"></i> New
                      </button>
                      <ul class="dropdown-menu">
                        <li>
                          <a
                            class="dropdown-item"
                            href="#"
                            onclick="showCreateFolder()"
                          >
                            <i class="fas fa-folder-plus"></i> New Folder
                          </a>
                        </li>
                        <li>
                          <a
                            class="dropdown-item"
                            href="#"
                            onclick="showUpload()"
                          >
                            <i class="fas fa-upload"></i> Upload Files
                          </a>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Selection Bar -->
          <div class="container-fluid">
            <div class="selection-bar" id="selectionBar">
              <div><span id="selectionCount">0</span> items selected</div>
              <div class="d-flex gap-2">
                <button
                  class="btn btn-sm btn-light"
                  onclick="downloadSelected()"
                >
                  <i class="fas fa-download"></i> Download
                </button>
                <button
                  class="btn btn-sm btn-danger"
                  onclick="deleteSelected()"
                >
                  <i class="fas fa-trash"></i> Delete
                </button>
                <button
                  class="btn btn-sm btn-secondary"
                  onclick="clearSelection()"
                >
                  <i class="fas fa-times"></i> Clear
                </button>
              </div>
            </div>
          </div>

          <!-- File Content -->
          <div class="container-fluid">
            <!-- Loading -->
            <div id="loading" class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <div class="mt-2">Loading files...</div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="text-center py-5" style="display: none">
              <i
                class="fas fa-folder-open text-muted"
                style="font-size: 4rem"
              ></i>
              <h5 class="mt-3 text-muted">This folder is empty</h5>
              <p class="text-muted">
                Upload files or create a new folder to get started
              </p>
              <button class="btn btn-primary" onclick="showUpload()">
                <i class="fas fa-upload"></i> Upload Files
              </button>
            </div>

            <!-- Grid View -->
            <div id="fileGrid" class="file-grid" style="display: none"></div>

            <!-- List View -->
            <div id="fileList" class="file-list" style="display: none">
              <div class="file-list-header">
                <input type="checkbox" id="selectAll" />
                <div class="sort-header" onclick="sortBy('name')">
                  Name <i class="fas fa-sort" id="sortName"></i>
                </div>
                <div
                  class="sort-header d-none d-md-block"
                  onclick="sortBy('size')"
                >
                  Size <i class="fas fa-sort" id="sortSize"></i>
                </div>
                <div
                  class="sort-header d-none d-md-block"
                  onclick="sortBy('modified')"
                >
                  Modified <i class="fas fa-sort" id="sortModified"></i>
                </div>
                <div
                  class="sort-header d-none d-md-block"
                  onclick="sortBy('type')"
                >
                  Type <i class="fas fa-sort" id="sortType"></i>
                </div>
                <div></div>
              </div>
              <div id="fileListContent"></div>
            </div>

            <!-- Search Results -->
            <div id="searchResults" style="display: none">
              <h6 class="mb-3">Search Results</h6>
              <div id="searchResultsContent"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
      <div class="context-menu-item" onclick="downloadFile()">
        <i class="fas fa-download"></i> Download
      </div>
      <div class="context-menu-item" onclick="renameFile()">
        <i class="fas fa-edit"></i> Rename
      </div>
      <div class="context-menu-item" onclick="deleteFile()">
        <i class="fas fa-trash"></i> Delete
      </div>
    </div>

    <!-- Modals -->
    <!-- Create Folder Modal -->
    <div class="modal fade" id="createFolderModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Create New Folder</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <input
              type="text"
              class="form-control"
              id="folderNameInput"
              placeholder="Folder name"
            />
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="createFolder()"
            >
              Create
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Upload Files</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="upload-zone" id="uploadZone">
              <i
                class="fas fa-cloud-upload-alt text-muted"
                style="font-size: 3rem"
              ></i>
              <h6 class="mt-3">Drag & drop files here</h6>
              <p class="text-muted">or click to select files</p>
              <input
                type="file"
                id="fileInput"
                multiple
                style="display: none"
              />
              <button
                class="btn btn-outline-primary"
                onclick="document.getElementById('fileInput').click()"
              >
                Select Files
              </button>
            </div>
            <div id="uploadProgress" style="display: none">
              <div class="progress mt-3">
                <div
                  class="progress-bar"
                  role="progressbar"
                  style="width: 0%"
                ></div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="uploadBtn"
              onclick="uploadFiles()"
              style="display: none"
            >
              Upload
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Rename Modal -->
    <div class="modal fade" id="renameModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Rename Item</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <input
              type="text"
              class="form-control"
              id="renameInput"
              placeholder="New name"
            />
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="confirmRename()"
            >
              Rename
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Global variables
      let currentPath = "{{ current_path }}";
      let currentView = "grid";
      let selectedItems = new Set();
      let currentSort = "name";
      let currentOrder = "asc";
      let contextMenuItem = null;
      let searchTimeout = null;

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        loadDirectory(currentPath);
        updateStorageInfo();

        // Setup event listeners
        setupEventListeners();
      });

      function setupEventListeners() {
        // Search input
        document
          .getElementById("searchInput")
          .addEventListener("input", function () {
            clearTimeout(searchTimeout);
            const query = this.value.trim();

            if (query.length >= 2) {
              searchTimeout = setTimeout(() => searchFiles(query), 300);
            } else if (query.length === 0) {
              hideSearchResults();
              loadDirectory(currentPath);
            }
          });

        // File input change
        document
          .getElementById("fileInput")
          .addEventListener("change", function () {
            const files = this.files;
            if (files.length > 0) {
              document.getElementById("uploadBtn").style.display = "block";
            }
          });

        // Upload zone drag and drop
        const uploadZone = document.getElementById("uploadZone");
        uploadZone.addEventListener("dragover", function (e) {
          e.preventDefault();
          this.classList.add("dragover");
        });

        uploadZone.addEventListener("dragleave", function (e) {
          e.preventDefault();
          this.classList.remove("dragover");
        });

        uploadZone.addEventListener("drop", function (e) {
          e.preventDefault();
          this.classList.remove("dragover");
          const files = e.dataTransfer.files;
          document.getElementById("fileInput").files = files;
          if (files.length > 0) {
            document.getElementById("uploadBtn").style.display = "block";
          }
        });

        // Select all checkbox
        document
          .getElementById("selectAll")
          .addEventListener("change", function () {
            if (this.checked) {
              selectAll();
            } else {
              clearSelection();
            }
          });

        // Context menu
        document.addEventListener("click", function () {
          hideContextMenu();
        });

        // Escape key to clear selection
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            clearSelection();
            hideContextMenu();
          }
        });
      }

      // Navigation
      function navigateTo(path) {
        currentPath = path;
        clearSelection();
        loadDirectory(path);

        // Update active sidebar link
        document.querySelectorAll(".sidebar .nav-link").forEach((link) => {
          link.classList.remove("active");
        });
        event.target.classList.add("active");
      }

      function loadDirectory(path) {
        showLoading();

        fetch(
          `/api/browse?path=${encodeURIComponent(
            path
          )}&sort=${currentSort}&order=${currentOrder}`
        )
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              showError(data.error);
              return;
            }

            currentPath = data.current_path;
            updateBreadcrumb(data.breadcrumbs);
            displayContents(data.contents);
            hideLoading();

            // Show empty state if no contents
            if (data.contents.length === 0) {
              showEmptyState();
            }
          })
          .catch((error) => {
            showError("Failed to load directory: " + error.message);
            hideLoading();
          });
      }

      function updateBreadcrumb(breadcrumbs) {
        const breadcrumbEl = document.getElementById("breadcrumb");
        breadcrumbEl.innerHTML = "";

        breadcrumbs.forEach((crumb, index) => {
          const li = document.createElement("li");
          li.className = "breadcrumb-item";

          if (index === breadcrumbs.length - 1) {
            li.classList.add("active");
            li.textContent = crumb.name;
          } else {
            const a = document.createElement("a");
            a.href = "#";
            a.textContent = crumb.name;
            a.onclick = () => navigateTo(crumb.path);
            li.appendChild(a);
          }

          breadcrumbEl.appendChild(li);
        });
      }

      // Display functions
      function displayContents(contents) {
        if (currentView === "grid") {
          displayGrid(contents);
        } else {
          displayList(contents);
        }

        hideEmptyState();
      }

      function displayGrid(contents) {
        const gridEl = document.getElementById("fileGrid");
        const listEl = document.getElementById("fileList");

        gridEl.style.display = "grid";
        listEl.style.display = "none";

        gridEl.innerHTML = "";

        contents.forEach((item) => {
          const itemEl = createGridItem(item);
          gridEl.appendChild(itemEl);
        });
      }

      function displayList(contents) {
        const gridEl = document.getElementById("fileGrid");
        const listEl = document.getElementById("fileList");

        gridEl.style.display = "none";
        listEl.style.display = "block";

        const contentEl = document.getElementById("fileListContent");
        contentEl.innerHTML = "";

        contents.forEach((item) => {
          const itemEl = createListItem(item);
          contentEl.appendChild(itemEl);
        });
      }

      function createGridItem(item) {
        const div = document.createElement("div");
        div.className = "file-item";
        div.dataset.path =
          item.type === "folder"
            ? `${currentPath}/${item.name}`
            : `${currentPath}/${item.name}`;
        div.dataset.type = item.type;
        div.dataset.name = item.name;

        const icon = getFileIcon(item);
        const info =
          item.type === "folder"
            ? `${item.file_count} files`
            : item.size_formatted;

        div.innerHTML = `
                <i class="${icon} file-icon ${item.category || item.type}"></i>
                <div class="file-name">${item.name}</div>
                <div class="file-info">
                    ${info}<br>
                    <small>${item.modified}</small>
                </div>
            `;

        div.addEventListener("click", function (e) {
          handleItemClick(this, e);
        });

        div.addEventListener("dblclick", function () {
          openItem(this);
        });

        div.addEventListener("contextmenu", function (e) {
          showContextMenu(e, this);
        });

        return div;
      }

      function createListItem(item) {
        const div = document.createElement("div");
        div.className = "file-list-item";
        div.dataset.path =
          item.type === "folder"
            ? `${currentPath}/${item.name}`
            : `${currentPath}/${item.name}`;
        div.dataset.type = item.type;
        div.dataset.name = item.name;

        const icon = getFileIcon(item);
        const info =
          item.type === "folder"
            ? `${item.file_count} files`
            : item.size_formatted;

        div.innerHTML = `
                <input type="checkbox" class="item-checkbox">
                <div class="d-flex align-items-center">
                    <i class="${icon} me-2 ${item.category || item.type}"></i>
                    ${item.name}
                </div>
                <div class="d-none d-md-block">${info}</div>
                <div class="d-none d-md-block">${item.modified}</div>
                <div class="d-none d-md-block">${item.type}</div>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="downloadItem('${
                          div.dataset.path
                        }')">Download</a></li>
                        <li><a class="dropdown-item" href="#" onclick="renameItem('${
                          div.dataset.path
                        }')">Rename</a></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteItem('${
                          div.dataset.path
                        }')">Delete</a></li>
                    </ul>
                </div>
            `;

        div.addEventListener("click", function (e) {
          if (
            !e.target.matches('input[type="checkbox"]') &&
            !e.target.closest(".dropdown")
          ) {
            handleItemClick(this, e);
          }
        });

        div.addEventListener("dblclick", function () {
          openItem(this);
        });

        const checkbox = div.querySelector(".item-checkbox");
        checkbox.addEventListener("change", function () {
          toggleSelection(div);
        });

        return div;
      }

      function getFileIcon(item) {
        if (item.type === "folder") {
          return "fas fa-folder";
        }

        const category = item.category || "file";
        const iconMap = {
          image: "fas fa-image",
          video: "fas fa-video",
          audio: "fas fa-music",
          text: "fas fa-file-alt",
          code: "fas fa-code",
          pdf: "fas fa-file-pdf",
          archive: "fas fa-file-archive",
          model: "fas fa-brain",
          file: "fas fa-file",
        };

        return iconMap[category] || "fas fa-file";
      }

      // Selection handling
      function handleItemClick(element, event) {
        if (event.ctrlKey || event.metaKey) {
          toggleSelection(element);
        } else if (event.shiftKey && selectedItems.size > 0) {
          // Implement shift selection
          selectRange(element);
        } else {
          clearSelection();
          selectItem(element);
        }
      }

      function selectItem(element) {
        element.classList.add("selected");
        selectedItems.add(element.dataset.path);
        updateSelectionBar();

        const checkbox = element.querySelector(".item-checkbox");
        if (checkbox) checkbox.checked = true;
      }

      function deselectItem(element) {
        element.classList.remove("selected");
        selectedItems.delete(element.dataset.path);
        updateSelectionBar();

        const checkbox = element.querySelector(".item-checkbox");
        if (checkbox) checkbox.checked = false;
      }

      function toggleSelection(element) {
        if (selectedItems.has(element.dataset.path)) {
          deselectItem(element);
        } else {
          selectItem(element);
        }
      }

      function selectAll() {
        clearSelection();
        document
          .querySelectorAll(".file-item, .file-list-item")
          .forEach((item) => {
            selectItem(item);
          });
      }

      function clearSelection() {
        selectedItems.clear();
        document
          .querySelectorAll(".file-item.selected, .file-list-item.selected")
          .forEach((item) => {
            item.classList.remove("selected");
            const checkbox = item.querySelector(".item-checkbox");
            if (checkbox) checkbox.checked = false;
          });
        updateSelectionBar();
        document.getElementById("selectAll").checked = false;
      }

      function updateSelectionBar() {
        const bar = document.getElementById("selectionBar");
        const count = document.getElementById("selectionCount");

        if (selectedItems.size > 0) {
          bar.style.display = "flex";
          count.textContent = selectedItems.size;
        } else {
          bar.style.display = "none";
        }
      }

      // File operations
      function openItem(element) {
        const path = element.dataset.path;
        const type = element.dataset.type;

        if (type === "folder") {
          navigateTo(path);
        } else {
          downloadItem(path);
        }
      }

      function downloadItem(path) {
        window.open(`/api/download?path=${encodeURIComponent(path)}`, "_blank");
      }

      function downloadSelected() {
        if (selectedItems.size === 0) return;

        if (selectedItems.size === 1) {
          const path = Array.from(selectedItems)[0];
          downloadItem(path);
        } else {
          // Download multiple files as zip
          fetch("/api/download_multiple", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ files: Array.from(selectedItems) }),
          })
            .then((response) => response.blob())
            .then((blob) => {
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = "selected_files.zip";
              a.click();
              window.URL.revokeObjectURL(url);
            })
            .catch((error) => showError("Download failed: " + error.message));
        }
      }

      function deleteSelected() {
        if (selectedItems.size === 0) return;

        if (confirm(`Delete ${selectedItems.size} item(s)?`)) {
          fetch("/api/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ items: Array.from(selectedItems) }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                clearSelection();
                loadDirectory(currentPath);
                showSuccess("Items deleted successfully");
              } else {
                showError("Some items could not be deleted");
              }
            })
            .catch((error) => showError("Delete failed: " + error.message));
        }
      }

      // View controls
      function setView(view) {
        currentView = view;

        document
          .getElementById("gridView")
          .classList.toggle("active", view === "grid");
        document
          .getElementById("listView")
          .classList.toggle("active", view === "list");

        // Reload current contents in new view
        if (
          document.getElementById("fileGrid").children.length > 0 ||
          document.getElementById("fileListContent").children.length > 0
        ) {
          loadDirectory(currentPath);
        }
      }

      function sortBy(field) {
        if (currentSort === field) {
          currentOrder = currentOrder === "asc" ? "desc" : "asc";
        } else {
          currentSort = field;
          currentOrder = "asc";
        }

        // Update sort indicators
        document.querySelectorAll(".sort-header i").forEach((icon) => {
          icon.className = "fas fa-sort";
        });

        const sortIcon = document.getElementById(
          `sort${field.charAt(0).toUpperCase() + field.slice(1)}`
        );
        if (sortIcon) {
          sortIcon.className = `fas fa-sort-${
            currentOrder === "asc" ? "up" : "down"
          }`;
        }

        loadDirectory(currentPath);
      }

      // Modals and actions
      function showCreateFolder() {
        const modal = new bootstrap.Modal(
          document.getElementById("createFolderModal")
        );
        modal.show();

        // Focus input when modal is shown
        document
          .getElementById("createFolderModal")
          .addEventListener("shown.bs.modal", function () {
            document.getElementById("folderNameInput").focus();
          });
      }

      function createFolder() {
        const name = document.getElementById("folderNameInput").value.trim();
        if (!name) return;

        fetch("/api/create_folder", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            current_path: currentPath,
            folder_name: name,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              bootstrap.Modal.getInstance(
                document.getElementById("createFolderModal")
              ).hide();
              document.getElementById("folderNameInput").value = "";
              loadDirectory(currentPath);
              showSuccess("Folder created successfully");
            } else {
              showError(data.error);
            }
          })
          .catch((error) =>
            showError("Failed to create folder: " + error.message)
          );
      }

      function showUpload() {
        const modal = new bootstrap.Modal(
          document.getElementById("uploadModal")
        );
        modal.show();
      }

      function uploadFiles() {
        const files = document.getElementById("fileInput").files;
        if (files.length === 0) return;

        const formData = new FormData();
        formData.append("current_path", currentPath);

        for (let file of files) {
          formData.append("files", file);
        }

        // Show progress
        const progressContainer = document.getElementById("uploadProgress");
        const progressBar = progressContainer.querySelector(".progress-bar");
        progressContainer.style.display = "block";

        fetch("/api/upload", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            bootstrap.Modal.getInstance(
              document.getElementById("uploadModal")
            ).hide();
            progressContainer.style.display = "none";
            document.getElementById("fileInput").value = "";
            document.getElementById("uploadBtn").style.display = "none";

            if (data.success) {
              loadDirectory(currentPath);
              showSuccess("Files uploaded successfully");
            } else {
              showError("Some files could not be uploaded");
            }
          })
          .catch((error) => {
            progressContainer.style.display = "none";
            showError("Upload failed: " + error.message);
          });
      }

      // Context menu
      function showContextMenu(event, element) {
        event.preventDefault();
        contextMenuItem = element;

        const menu = document.getElementById("contextMenu");
        menu.style.display = "block";
        menu.style.left = event.pageX + "px";
        menu.style.top = event.pageY + "px";
      }

      function hideContextMenu() {
        document.getElementById("contextMenu").style.display = "none";
        contextMenuItem = null;
      }

      function downloadFile() {
        if (contextMenuItem) {
          downloadItem(contextMenuItem.dataset.path);
          hideContextMenu();
        }
      }

      function renameFile() {
        if (contextMenuItem) {
          renameItem(contextMenuItem.dataset.path);
          hideContextMenu();
        }
      }

      function deleteFile() {
        if (contextMenuItem) {
          deleteItem(contextMenuItem.dataset.path);
          hideContextMenu();
        }
      }

      function renameItem(path) {
        const modal = new bootstrap.Modal(
          document.getElementById("renameModal")
        );
        const input = document.getElementById("renameInput");
        const currentName = path.split("/").pop();

        input.value = currentName;
        modal.show();

        // Store path for rename operation
        document.getElementById("renameModal").dataset.path = path;

        // Focus and select text
        document
          .getElementById("renameModal")
          .addEventListener("shown.bs.modal", function () {
            input.focus();
            input.select();
          });
      }

      function confirmRename() {
        const modal = document.getElementById("renameModal");
        const oldPath = modal.dataset.path;
        const newName = document.getElementById("renameInput").value.trim();

        if (!newName) return;

        fetch("/api/rename", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            old_path: oldPath,
            new_name: newName,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              bootstrap.Modal.getInstance(modal).hide();
              loadDirectory(currentPath);
              showSuccess("Item renamed successfully");
            } else {
              showError(data.error);
            }
          })
          .catch((error) => showError("Rename failed: " + error.message));
      }

      function deleteItem(path) {
        if (confirm("Delete this item?")) {
          fetch("/api/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ items: [path] }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                loadDirectory(currentPath);
                showSuccess("Item deleted successfully");
              } else {
                showError(data.errors[0] || "Delete failed");
              }
            })
            .catch((error) => showError("Delete failed: " + error.message));
        }
      }

      // Search
      function searchFiles(query) {
        fetch(
          `/api/search?q=${encodeURIComponent(query)}&path=${encodeURIComponent(
            currentPath
          )}`
        )
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              showError(data.error);
              return;
            }

            showSearchResults(data.results, query);
          })
          .catch((error) => showError("Search failed: " + error.message));
      }

      function showSearchResults(results, query) {
        const searchEl = document.getElementById("searchResults");
        const contentEl = document.getElementById("searchResultsContent");

        // Hide other views
        document.getElementById("fileGrid").style.display = "none";
        document.getElementById("fileList").style.display = "none";
        document.getElementById("emptyState").style.display = "none";

        searchEl.style.display = "block";
        searchEl.querySelector(
          "h6"
        ).textContent = `Search Results for "${query}" (${results.length})`;

        contentEl.innerHTML = "";

        if (results.length === 0) {
          contentEl.innerHTML =
            '<p class="text-muted">No files found matching your search.</p>';
          return;
        }

        results.forEach((item) => {
          const div = document.createElement("div");
          div.className = "search-result-item p-3 border-bottom";
          div.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="${getFileIcon(item)} me-3 text-primary"></i>
                        <div class="flex-grow-1">
                            <div class="fw-bold">${item.name}</div>
                            <small class="text-muted">${
                              item.relative_path
                            }</small>
                            ${
                              item.size_formatted
                                ? `<small class="text-muted ms-3">${item.size_formatted}</small>`
                                : ""
                            }
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="downloadItem('${
                          item.path
                        }')">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                `;
          contentEl.appendChild(div);
        });
      }

      function hideSearchResults() {
        document.getElementById("searchResults").style.display = "none";
      }

      // Storage info
      function updateStorageInfo() {
        fetch(`/api/storage_info?path=${encodeURIComponent(currentPath)}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.error) return;

            const progressBar = document.querySelector(
              "#storageInfo .progress-bar"
            );
            const usedSpace = document.getElementById("usedSpace");
            const totalSpace = document.getElementById("totalSpace");

            progressBar.style.width = data.disk_usage_percent + "%";
            progressBar.className = `progress-bar ${
              data.disk_usage_percent > 90
                ? "bg-danger"
                : data.disk_usage_percent > 75
                ? "bg-warning"
                : "bg-success"
            }`;

            usedSpace.textContent = data.disk_used_formatted;
            totalSpace.textContent = data.disk_total_formatted;
          })
          .catch((error) =>
            console.error("Failed to update storage info:", error)
          );
      }

      // Utility functions
      function showLoading() {
        document.getElementById("loading").style.display = "block";
        document.getElementById("fileGrid").style.display = "none";
        document.getElementById("fileList").style.display = "none";
        document.getElementById("emptyState").style.display = "none";
        hideSearchResults();
      }

      function hideLoading() {
        document.getElementById("loading").style.display = "none";
      }

      function showEmptyState() {
        document.getElementById("emptyState").style.display = "block";
        document.getElementById("fileGrid").style.display = "none";
        document.getElementById("fileList").style.display = "none";
      }

      function hideEmptyState() {
        document.getElementById("emptyState").style.display = "none";
      }

      function showSuccess(message) {
        // Simple toast notification
        const toast = document.createElement("div");
        toast.className =
          "toast align-items-center text-white bg-success border-0 position-fixed";
        toast.style.cssText = "top: 20px; right: 20px; z-index: 1060;";
        toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

        document.body.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();

        toast.addEventListener("hidden.bs.toast", function () {
          toast.remove();
        });
      }

      function showError(message) {
        const toast = document.createElement("div");
        toast.className =
          "toast align-items-center text-white bg-danger border-0 position-fixed";
        toast.style.cssText = "top: 20px; right: 20px; z-index: 1060;";
        toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

        document.body.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();

        toast.addEventListener("hidden.bs.toast", function () {
          toast.remove();
        });
      }
    </script>
  </body>
</html>
