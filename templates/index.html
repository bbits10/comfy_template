<!DOCTYPE html>
<html>
  <head>
    <title>ComfyUI Model Downloader</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .model-card {
        margin-bottom: 20px;
      }
      .progress {
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="mb-4">ComfyUI Model Downloader</h1>

      {% for model_set_id, model_set in model_configs.items() %}
      <div class="card mb-4">
        <div class="card-header">
          <h2>{{ model_set.name }}</h2>
        </div>
        <div class="card-body">
          <div class="row">
            {% for model_id, model in model_set.models.items() %}
            <div class="col-md-6">
              <div class="card model-card">
                <div class="card-body">
                  <h5 class="card-title">{{ model.name }}</h5>
                  <p class="card-text">Path: {{ model.path }}</p>
                  {% if model.description %}
                  <p class="card-text">
                    <small class="text-muted">{{ model.description }}</small>
                  </p>
                  {% endif %}
                  <button
                    class="btn btn-primary download-btn"
                    data-model-id="{{ model_id }}"
                    data-model-set="{{ model_set_id }}"
                  >
                    Download
                  </button>
                  <div class="progress d-none">
                    <div
                      class="progress-bar"
                      role="progressbar"
                      style="width: 0%"
                    >
                      0%
                    </div>
                  </div>
                  <div class="status-text mt-2"></div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $(document).ready(function () {
        $(".download-btn").click(function () {
          const btn = $(this);
          const modelId = btn.data("model-id");
          const modelSet = btn.data("model-set");
          const progressBar = btn.siblings(".progress");
          const statusText = btn.siblings(".status-text");

          progressBar.removeClass("d-none");
          btn.prop("disabled", true);

          // Start download
          $.post("/download", {
            model_id: modelId,
            model_set: modelSet,
          })
            .done(function (response) {
              checkStatus(response.destination, progressBar, statusText, btn);
            })
            .fail(function (xhr) {
              statusText.text("Error: " + xhr.responseJSON.error);
              btn.prop("disabled", false);
            });
        });

        function checkStatus(destination, progressBar, statusText, btn) {
          $.get("/status").done(function (status) {
            if (destination in status) {
              const download = status[destination];
              const progressBarInner = progressBar.find(".progress-bar");

              progressBarInner.css("width", download.progress + "%");
              progressBarInner.text(download.progress + "%");

              if (download.status === "completed") {
                statusText.text("Download completed!");
                btn.prop("disabled", false);
              } else if (download.status === "error") {
                statusText.text("Error: " + download.error);
                btn.prop("disabled", false);
              } else {
                setTimeout(
                  () => checkStatus(destination, progressBar, statusText, btn),
                  1000
                );
              }
            } else {
              setTimeout(
                () => checkStatus(destination, progressBar, statusText, btn),
                1000
              );
            }
          });
        }
      });
    </script>
  </body>
</html>
